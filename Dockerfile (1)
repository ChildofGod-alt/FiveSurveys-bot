
# Use Ubuntu 22.04 (includes GLIBC >= 2.35, and we can install 2.38)
FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    gnupg \
    ca-certificates \
    software-properties-common \
    libglib2.0-0 \
    libnss3 \
    libatk-bridge2.0-0 \
    libxss1 \
    libasound2 \
    libxshmfence-dev \
    libgbm-dev \
    libgtk-3-0 \
    python3.10 \
    python3-pip \
    python3-venv \
    unzip \
    fonts-liberation \
    libappindicator3-1 \
    xdg-utils \
    --no-install-recommends

# Install latest GLIBC (2.38)
RUN apt-get update && \
    apt-get install -y libc6-dev libc6 && \
    wget http://ftp.gnu.org/gnu/libc/glibc-2.38.tar.gz && \
    tar -xvzf glibc-2.38.tar.gz && \
    cd glibc-2.38 && \
    mkdir build && cd build && \
    ../configure --prefix=/opt/glibc-2.38 && \
    make -j$(nproc) && \
    make install && \
    cd ../.. && rm -rf glibc-2.38 glibc-2.38.tar.gz

ENV LD_LIBRARY_PATH=/opt/glibc-2.38/lib:$LD_LIBRARY_PATH

# Set workdir
WORKDIR /app

# Copy everything
COPY . .

# Install Python dependencies
RUN pip3 install --upgrade pip && \
    pip3 install -r requirements.txt && \
    playwright install

# Run bot
CMD ["python3", "fivesurveys_bot.py"]
